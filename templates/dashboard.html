<!DOCTYPE html>
<html lang="en" data-theme="corporate">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Gateway - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* Layout */
        :root {
            --sidebar-w: 256px;
            --sidebar-w-collapsed: 72px;
            --navbar-h: 64px;
        }

        .stat-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        /* Sidebar */
        #sidebar {
            position: fixed;
            top: var(--navbar-h);
            left: 0;
            bottom: 0;
            width: var(--sidebar-w);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 20;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* Main content */
        #main-wrapper {
            padding-top: var(--navbar-h);
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Sidebar text transition */
        .sidebar-text {
            transition: opacity 0.15s ease, max-width 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            max-width: 200px;
        }

        .sidebar-footer {
            transition: opacity 0.2s ease;
        }

        /* ── Desktop ────────────────────────────────── */
        @media (min-width: 1024px) {
            #main-wrapper {
                margin-left: var(--sidebar-w);
            }

            /* Collapsed state */
            body.sidebar-collapsed #sidebar {
                width: var(--sidebar-w-collapsed);
            }

            body.sidebar-collapsed #main-wrapper {
                margin-left: var(--sidebar-w-collapsed);
            }

            body.sidebar-collapsed .sidebar-text {
                opacity: 0;
                max-width: 0;
            }

            body.sidebar-collapsed .sidebar-footer {
                opacity: 0;
                pointer-events: none;
            }

            body.sidebar-collapsed #sidebar .menu {
                padding: 0.5rem;
            }

            body.sidebar-collapsed #sidebar .menu a {
                justify-content: center;
                padding-inline: 0;
                gap: 0;
            }

            body.sidebar-collapsed #sidebar .menu li {
                position: relative;
            }

            /* Tooltip on hover when collapsed */
            body.sidebar-collapsed #sidebar .menu a[data-tip]:hover::after {
                content: attr(data-tip);
                position: absolute;
                left: calc(100% + 10px);
                top: 50%;
                transform: translateY(-50%);
                background: #1f2937;
                color: #fff;
                padding: 4px 12px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 500;
                white-space: nowrap;
                z-index: 100;
                pointer-events: none;
                box-shadow: 0 2px 8px rgb(0 0 0 / 0.15);
            }

            /* Toggle icon rotation */
            body.sidebar-collapsed #toggle-icon {
                transform: rotate(180deg);
            }
        }

        /* ── Mobile ──────────────────────────────────── */
        @media (max-width: 1023px) {
            #sidebar {
                transform: translateX(-100%);
                width: var(--sidebar-w);
            }

            body.sidebar-open #sidebar {
                transform: translateX(0);
            }

            #main-wrapper {
                margin-left: 0 !important;
            }
        }

        #sidebar-overlay {
            transition: opacity 0.3s ease;
        }

        #toggle-icon {
            transition: transform 0.3s ease;
        }

        /* Scrollbar styling for sidebar */
        #sidebar::-webkit-scrollbar {
            width: 4px;
        }

        #sidebar::-webkit-scrollbar-thumb {
            background: transparent;
            border-radius: 4px;
        }

        #sidebar:hover::-webkit-scrollbar-thumb {
            background: oklch(0.8 0 0);
        }
    </style>
</head>

<body class="bg-base-200 min-h-screen">

    <!-- ═══════════════════════════════════════════════
         Fixed Navbar
         ═══════════════════════════════════════════════ -->
    <nav class="navbar fixed top-0 left-0 right-0 h-16 z-30 bg-base-100 border-b border-base-300 px-2 lg:px-4">
        <div class="flex-1 gap-1">
            <!-- Sidebar toggle -->
            <button onclick="toggleSidebar()" class="btn btn-ghost btn-sm btn-square" aria-label="Toggle sidebar">
                <svg id="toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25H12" />
                </svg>
            </button>

            <a href="/admin/dashboard" class="btn btn-ghost font-bold gap-2 text-lg px-2">
                <div class="w-16 h-8 text-primary-content flex items-center justify-center">
                    <img src="./assets/atmi-logo.PNG" alt="API Gateway Logo" class="object-contain" />
                </div>
                <span class="hidden sm:inline">API Gateway</span>
            </a>

            <span class="badge badge-outline badge-success badge-sm ml-1">
                <div class="inline-grid *:[grid-area:1/1]">
                    <div class="status status-success animate-ping"></div>
                    <div class="status status-success"></div>
                </div>
                Online
            </span>
        </div>
        <div class="flex-none gap-2 p-4">
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar placeholder">
                    <div class="bg-neutral text-neutral-content rounded-full w-10 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="size-6">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                        </svg>
                    </div>
                </div>
                <ul tabindex="0"
                    class="mt-3 z-[1] p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52">
                    <li class="menu-title"><span id="adminName" class="badge badge-neutral text-sm"></span></li>
                    <li class="menu-title" id="fullName"></li>
                    <li><a onclick="handleLogout()" class="text-error">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" />
                            </svg>
                            Logout
                        </a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- ═══════════════════════════════════════════════
         Sidebar
         ═══════════════════════════════════════════════ -->
    <aside id="sidebar" class="bg-base-100 border-r border-base-300 flex flex-col">
        <ul class="menu p-2 text-base-content w-full gap-1 flex-1">
            <li><a onclick="showSection('dashboard')" class="active" id="nav-dashboard" data-tip="Dashboard">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-5 h-5 shrink-0">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25a2.25 2.25 0 0 1-2.25-2.25v-2.25Z" />
                    </svg>
                    <span class="sidebar-text">Dashboard</span>
                </a></li>
            <li><a onclick="showSection('tokens')" id="nav-tokens" data-tip="API Tokens">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-5 h-5 shrink-0">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z" />
                    </svg>
                    <span class="sidebar-text">API Tokens</span>
                </a></li>
            <li><a onclick="showSection('analytics')" id="nav-analytics" data-tip="Analytics">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-5 h-5 shrink-0">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                    </svg>
                    <span class="sidebar-text">Analytics</span>
                </a></li>
            <li><a onclick="showSection('audit')" id="nav-audit" data-tip="Audit Logs">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-5 h-5 shrink-0">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15a2.25 2.25 0 0 1 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25ZM6.75 12h.008v.008H6.75V12Zm0 3h.008v.008H6.75V15Zm0 3h.008v.008H6.75V18Z" />
                    </svg>
                    <span class="sidebar-text">Audit Logs</span>
                </a></li>
        </ul>
        <div class="sidebar-footer p-4 border-t border-base-300">
            <div class="text-xs text-center text-base-content/50">
                &copy; Wahyu Bimo - Made with <span class="text-error">❤</span>
            </div>
        </div>
    </aside>

    <!-- Mobile overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/40 z-10 hidden lg:!hidden" onclick="toggleSidebar()">
    </div>

    <!-- ═══════════════════════════════════════════════
         Main Content
         ═══════════════════════════════════════════════ -->
    <div id="main-wrapper" class="min-h-screen">
        <main id="main-content" class="p-6 w-full max-w-7xl mx-auto">

            <!-- Dashboard Section -->
            <div id="section-dashboard">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Overview</h2>
                    <button class="btn btn-ghost btn-sm" onclick="loadDashboard()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182M2.985 19.644l3.181-3.182" />
                        </svg>
                        Refresh
                    </button>
                </div>

                <div class="stats stats-vertical bg-base-100 lg:stats-horizontal shadow w-full mb-8">
                    <div class="stat stat-card">
                        <div class="stat-figure text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" class="w-8 h-8">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z" />
                            </svg>
                        </div>
                        <div class="stat-title">Total Tokens</div>
                        <div class="stat-value text-primary" id="stat-total">0</div>
                        <div class="stat-desc">Registered API keys</div>
                    </div>
                    <div class="stat stat-card">
                        <div class="stat-figure text-success">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" class="w-8 h-8">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                            </svg>
                        </div>
                        <div class="stat-title">Active Tokens</div>
                        <div class="stat-value text-success" id="stat-active">0</div>
                        <div class="stat-desc">Currently in use</div>
                    </div>
                    <div class="stat stat-card">
                        <div class="stat-figure text-info">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" class="w-8 h-8">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="m3.75 13.5 10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z" />
                            </svg>
                        </div>
                        <div class="stat-title">Requests (24h)</div>
                        <div class="stat-value text-info" id="stat-requests">0</div>
                        <div class="stat-desc">Total volume</div>
                    </div>
                    <div class="stat stat-card">
                        <div class="stat-figure text-warning">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" class="w-8 h-8">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                            </svg>
                        </div>
                        <div class="stat-title">Success Rate</div>
                        <div class="stat-value text-warning" id="stat-success">0%</div>
                        <div class="stat-desc">Last 24 hours</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card bg-base-100 shadow">
                        <div class="card-body">
                            <h3 class="card-title text-lg">Traffic (Last 7 Days)</h3>
                            <div class="h-64">
                                <canvas id="dailyChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card bg-base-100 shadow">
                        <div class="card-body">
                            <h3 class="card-title text-lg">Top Endpoints</h3>
                            <div class="overflow-x-auto">
                                <table class="table table-sm table-zebra" id="endpointsTable">
                                    <thead>
                                        <tr>
                                            <th>Endpoint</th>
                                            <th>Method</th>
                                            <th class="text-right">Requests</th>
                                            <th class="text-right">Latency</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tokens Section -->
            <div id="section-tokens" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">API Tokens</h2>
                    <button onclick="showCreateTokenModal()" class="btn btn-primary btn-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                        Create Token
                    </button>
                </div>

                <div class="card bg-base-100 shadow">
                    <div class="overflow-x-auto">
                        <table class="table" id="tokensTable">
                            <thead>
                                <tr>
                                    <th>Token Details</th>
                                    <th>Prefix</th>
                                    <th>Env</th>
                                    <th>Status</th>
                                    <th>Usage</th>
                                    <th>Last Active</th>
                                    <th class="text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tokensBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="section-analytics" class="hidden">
                <h2 class="text-2xl font-bold mb-6">Detailed Analytics</h2>
                <div class="card bg-base-100 shadow mb-6">
                    <div class="card-body">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="card-title text-lg">Request Volume & Status</h3>
                            <select class="select select-bordered select-sm" onchange="loadAnalytics(this.value)">
                                <option value="7">Last 7 Days</option>
                                <option value="30" selected>Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                            </select>
                        </div>
                        <div class="h-80">
                            <canvas id="analyticsChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="card bg-base-100 shadow">
                    <div class="card-body">
                        <h3 class="card-title text-lg mb-4">Endpoint Performance</h3>
                        <div class="overflow-x-auto">
                            <table class="table table-zebra" id="analyticsEndpointsTable">
                                <thead>
                                    <tr>
                                        <th>Endpoint</th>
                                        <th>Method</th>
                                        <th class="text-right">Total</th>
                                        <th class="text-right text-success">Success</th>
                                        <th class="text-right text-error">Failed</th>
                                        <th class="text-right">Avg Latency</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audit Logs Section -->
            <div id="section-audit" class="hidden">
                <h2 class="text-2xl font-bold mb-6">Audit Logs</h2>
                <div class="card bg-base-100 shadow">
                    <div class="card-body p-0">
                        <div class="overflow-x-auto">
                            <table class="table" id="auditTable">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Action</th>
                                        <th>Resource</th>
                                        <th>Description</th>
                                        <th>IP Address</th>
                                    </tr>
                                </thead>
                                <tbody id="auditBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Context Menu (rendered outside table to avoid overflow clipping) -->
    <div id="tokenContextMenu" class="fixed z-50 hidden">
        <ul class="menu bg-base-100 rounded-box shadow-lg border border-base-300 w-36 p-1">
        </ul>
    </div>

    <!-- ═══════════════════════════════════════════════
         Modals
         ═══════════════════════════════════════════════ -->

    <!-- Create Token Modal -->
    <dialog id="createTokenModal" class="modal">
        <div class="modal-box w-11/12 max-w-2xl">
            <h3 class="font-bold text-lg mb-4">Create New API Token</h3>
            <form id="createTokenForm" onsubmit="handleCreateToken(event)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text">Token Name *</span></label>
                        <input type="text" name="name" class="input input-bordered" required
                            placeholder="e.g. Mobile App Prod" />
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Environment *</span></label>
                        <select name="environment" class="select select-bordered" required>
                            <option value="production">Production</option>
                            <option value="staging">Staging</option>
                            <option value="development" selected>Development</option>
                            <option value="test">Test</option>
                        </select>
                    </div>
                    <div class="form-control md:col-span-2">
                        <label class="label"><span class="label-text">Description</span></label>
                        <textarea name="description" class="textarea textarea-bordered h-20"
                            placeholder="Describe the purpose of this token..."></textarea>
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Scopes</span> <span
                                class="label-text-alt text-base-content/50">(comma-separated)</span></label>
                        <input type="text" name="scopes" class="input input-bordered"
                            placeholder="tickets:read, machines:write" />
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Expiration Date</span> <span
                                class="label-text-alt text-base-content/50">(optional)</span></label>
                        <input type="datetime-local" name="expires_at" class="input input-bordered" />
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Rate Limit / Min</span></label>
                        <input type="number" name="rate_limit_per_minute" class="input input-bordered" value="100" />
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Rate Limit / Hour</span></label>
                        <input type="number" name="rate_limit_per_hour" class="input input-bordered" value="5000" />
                    </div>
                    <div class="form-control md:col-span-2">
                        <label class="label"><span class="label-text">IP Whitelist</span> <span
                                class="label-text-alt text-base-content/50">(comma-separated IPs/CIDRs)</span></label>
                        <input type="text" name="ip_whitelist" class="input input-bordered"
                            placeholder="e.g. 192.168.1.1, 10.0.0.0/8" />
                    </div>
                </div>
                <div class="modal-action">
                    <button type="button" class="btn btn-ghost"
                        onclick="document.getElementById('createTokenModal').close()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Token</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Token Created Modal -->
    <dialog id="tokenCreatedModal" class="modal">
        <div class="modal-box">
            <div class="flex flex-col items-center mb-4">
                <div class="w-16 h-16 bg-success/20 text-success rounded-full flex items-center justify-center mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-8 h-8">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                    </svg>
                </div>
                <h3 class="font-bold text-xl">Token Created!</h3>
            </div>

            <div class="alert alert-warning text-sm mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-5 h-5 shrink-0">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                </svg>
                <span>Please copy this token now. You won't be able to see it again!</span>
            </div>

            <div class="form-control">
                <label class="label"><span class="label-text font-bold">API Token</span></label>
                <div class="join w-full">
                    <input type="text" id="newTokenValue"
                        class="input input-bordered input-primary join-item w-full font-mono text-sm bg-base-200"
                        readonly />
                    <button class="btn btn-primary join-item" onclick="copyToken()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9.75a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184" />
                        </svg>
                        Copy
                    </button>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn" onclick="document.getElementById('tokenCreatedModal').close(); loadTokens();">I have
                    copied it</button>
            </div>
        </div>
    </dialog>

    <!-- Token Detail Modal -->
    <dialog id="tokenDetailModal" class="modal">
        <div class="modal-box w-11/12 max-w-4xl">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="font-bold text-2xl" id="tokenDetailTitle">Token Details</h3>
                    <div class="text-sm text-base-content/60 mt-1" id="tokenDetailEnv"></div>
                </div>
                <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                        </svg>
                    </button></form>
            </div>
            <div id="tokenDetailContent"></div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- ═══════════════════════════════════════════════
         Scripts
         ═══════════════════════════════════════════════ -->
    <script>
        // ── Sidebar ────────────────────────────────────
        function toggleSidebar() {
            const isDesktop = window.innerWidth >= 1024;
            if (isDesktop) {
                document.body.classList.toggle('sidebar-collapsed');
                localStorage.setItem('sidebar-collapsed', document.body.classList.contains('sidebar-collapsed'));
            } else {
                const isOpen = document.body.classList.toggle('sidebar-open');
                document.getElementById('sidebar-overlay').classList.toggle('hidden', !isOpen);
            }
        }

        function closeMobileSidebar() {
            document.body.classList.remove('sidebar-open');
            document.getElementById('sidebar-overlay').classList.add('hidden');
        }

        // Restore desktop sidebar state
        if (window.innerWidth >= 1024 && localStorage.getItem('sidebar-collapsed') === 'true') {
            document.body.classList.add('sidebar-collapsed');
        }

        // Clean up on resize
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 1024) {
                closeMobileSidebar();
            }
        });

        // ── API ────────────────────────────────────────
        const API_BASE = '/api/v1/admin';
        let dailyChartInstance = null;
        let analyticsChartInstance = null;

        const chartColors = {
            primary: 'rgb(87, 13, 248)',
            primaryFade: 'rgba(87, 13, 248, 0.1)',
            success: 'rgb(34, 197, 94)',
            successFade: 'rgba(34, 197, 94, 0.1)',
            error: 'rgb(239, 68, 68)',
            errorFade: 'rgba(239, 68, 68, 0.1)'
        };

        function getHeaders() {
            const token = localStorage.getItem('session_token');
            return {
                'Content-Type': 'application/json',
                'X-Session-Token': token || ''
            };
        }

        async function apiFetch(url, options = {}) {
            options.headers = { ...getHeaders(), ...options.headers };
            try {
                const resp = await fetch(url, options);
                if (resp.status === 401) {
                    localStorage.removeItem('session_token');
                    window.location.href = '/admin/login';
                    return null;
                }
                return resp.json();
            } catch (e) {
                console.error("API Error:", e);
                return null;
            }
        }

        // Auth check
        if (!localStorage.getItem('session_token')) {
            window.location.href = '/admin/login';
        }

        // Show admin name
        try {
            const user = JSON.parse(localStorage.getItem('admin_user') || '{}');
            document.getElementById('adminName').textContent = user.username || 'Admin';
            document.getElementById('fullName').textContent = user.full_name || 'Admin';
            document.getElementById('userInitial').textContent = (user.username || 'A')[0].toUpperCase();
        } catch (e) { }

        async function handleLogout() {
            await apiFetch(`${API_BASE}/auth/logout`, { method: 'POST' });
            localStorage.removeItem('session_token');
            localStorage.removeItem('admin_user');
            window.location.href = '/admin/login';
        }

        // ── Navigation ────────────────────────────────
        function showSection(section) {
            ['dashboard', 'tokens', 'analytics', 'audit'].forEach(s => {
                const el = document.getElementById(`section-${s}`);
                const nav = document.getElementById(`nav-${s}`);

                if (s === section) {
                    el.classList.remove('hidden');
                    nav.classList.add('active');
                } else {
                    el.classList.add('hidden');
                    nav.classList.remove('active');
                }
            });

            // Close mobile sidebar after navigation
            if (window.innerWidth < 1024) {
                closeMobileSidebar();
            }

            if (section === 'dashboard') loadDashboard();
            if (section === 'tokens') loadTokens();
            if (section === 'analytics') loadAnalytics();
            if (section === 'audit') loadAuditLogs();
        }

        // ── Dashboard ─────────────────────────────────
        async function loadDashboard() {
            const data = await apiFetch(`${API_BASE}/analytics/dashboard`);
            if (!data || !data.success) return;
            const s = data.data;

            animateValue('stat-total', parseInt(document.getElementById('stat-total').textContent) || 0, s.total_tokens || 0, 1000);
            animateValue('stat-active', parseInt(document.getElementById('stat-active').textContent) || 0, s.active_tokens || 0, 1000);
            document.getElementById('stat-requests').textContent = (s.total_requests_24h || 0).toLocaleString();
            document.getElementById('stat-success').textContent = (s.success_rate || 0).toFixed(1) + '%';

            const daily = await apiFetch(`${API_BASE}/analytics/daily?days=7`);
            if (daily && daily.success) {
                const labels = daily.data.length > 0 ? [...new Set(daily.data.map(d => formatDate(d.date)))].sort() : [];
                const counts = labels.map(l => {
                    return daily.data.filter(d => formatDate(d.date) === l).reduce((a, b) => a + b.request_count, 0);
                });
                renderDailyChart(labels, counts);
            }

            const endpoints = await apiFetch(`${API_BASE}/analytics/endpoints?days=7&limit=5`);
            if (endpoints && endpoints.success) {
                const tbody = document.querySelector('#endpointsTable tbody');
                tbody.innerHTML = endpoints.data.map(e =>
                    `<tr>
                        <td class="font-mono text-xs truncate max-w-[200px]">${e.endpoint}</td>
                        <td><div class="badge badge-ghost badge-sm">${e.method}</div></td>
                        <td class="text-right font-bold">${e.request_count.toLocaleString()}</td>
                        <td class="text-right text-xs text-base-content/60">${(e.avg_response_time_ms || 0).toFixed(0)}ms</td>
                    </tr>`
                ).join('') || '<tr><td colspan="4" class="text-center text-base-content/50 py-4">No data available</td></tr>';
            }
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
        }

        function renderDailyChart(labels, data) {
            if (dailyChartInstance) dailyChartInstance.destroy();
            const ctx = document.getElementById('dailyChart').getContext('2d');
            dailyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Requests',
                        data,
                        backgroundColor: chartColors.primary,
                        borderRadius: 6,
                        maxBarThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 4], color: '#e5e7eb' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const obj = document.getElementById(id);
            const range = end - start;
            const minTimer = 50;
            let stepTime = Math.abs(Math.floor(duration / range));
            stepTime = Math.max(stepTime, minTimer);
            const startTime = new Date().getTime();
            const endTime = startTime + duration;
            let timer;

            function run() {
                const now = new Date().getTime();
                const remaining = Math.max((endTime - now) / duration, 0);
                const value = Math.round(end - (remaining * range));
                obj.innerHTML = value;
                if (value == end) {
                    clearInterval(timer);
                }
            }

            timer = setInterval(run, stepTime);
            run();
        }

        // ── Tokens ────────────────────────────────────
        async function loadTokens() {
            const data = await apiFetch(`${API_BASE}/tokens`);
            if (!data || !data.success) return;
            const tbody = document.getElementById('tokensBody');

            tbody.innerHTML = data.data.map(t => {
                const statusBadge = t.is_active
                    ? '<span class="badge badge-success badge-sm gap-1"><div class="w-2 h-2 rounded-full bg-success-content"></div> Active</span>'
                    : '<span class="badge badge-ghost badge-sm opacity-60">Disabled</span>';

                const envColors = {
                    production: 'badge-primary',
                    staging: 'badge-warning',
                    development: 'badge-info',
                    test: 'badge-ghost'
                };

                const lastUsed = t.last_used_at && t.last_used_at.indexOf('0001') === -1
                    ? `<div class="text-xs font-semibold">${new Date(t.last_used_at).toLocaleDateString()}</div><div class="text-[10px] text-base-content/50">${new Date(t.last_used_at).toLocaleTimeString()}</div>`
                    : '<span class="text-xs text-base-content/40">Never</span>';

                return `<tr class="hover">
                    <td>
                        <div class="font-bold">${t.name}</div>
                        <div class="text-xs text-base-content/50 truncate max-w-[200px]">${t.description || 'No description'}</div>
                    </td>
                    <td><code class="text-xs">${t.token}</code></td>
                    <td><span class="badge ${envColors[t.environment] || 'badge-ghost'} badge-outline badge-sm capitalize">${t.environment}</span></td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="text-xs font-bold">${(t.total_requests || 0).toLocaleString()}</div>
                        <div class="text-[10px] text-base-content/50">requests</div>
                    </td>
                    <td>${lastUsed}</td>
                    <td class="text-right">
                        <div class="join">
                            <button class="btn btn-ghost btn-xs join-item" onclick="viewTokenDetail(${t.id})">Details</button>
                            <button class="btn btn-ghost btn-xs join-item" onclick="showTokenMenu(event, ${t.id}, '${t.name.replace(/'/g, "\\'")}', ${t.is_active})">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" />
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('') || '<tr><td colspan="7" class="text-center py-12 text-base-content/50">No tokens found. Create your first one!</td></tr>';
        }

        function showCreateTokenModal() {
            document.getElementById('createTokenForm').reset();
            document.getElementById('createTokenModal').showModal();
        }

        async function handleCreateToken(e) {
            e.preventDefault();
            const form = new FormData(e.target);
            const body = {
                name: form.get('name'),
                description: form.get('description'),
                environment: form.get('environment'),
                scopes: form.get('scopes') ? form.get('scopes').split(',').map(s => s.trim()).filter(Boolean) : [],
                ip_whitelist: form.get('ip_whitelist') ? form.get('ip_whitelist').split(',').map(s => s.trim()).filter(Boolean) : [],
                rate_limit_per_minute: parseInt(form.get('rate_limit_per_minute')) || 100,
                rate_limit_per_hour: parseInt(form.get('rate_limit_per_hour')) || 5000,
                rate_limit_per_day: 100000
            };
            if (form.get('expires_at')) {
                body.expires_at = new Date(form.get('expires_at')).toISOString();
            }

            const data = await apiFetch(`${API_BASE}/tokens`, { method: 'POST', body: JSON.stringify(body) });
            if (!data) return;
            document.getElementById('createTokenModal').close();

            if (data.success) {
                document.getElementById('newTokenValue').value = data.data.token;
                document.getElementById('tokenCreatedModal').showModal();
            } else {
                alert(data.message || 'Failed to create token');
            }
        }

        function copyToken() {
            const input = document.getElementById('newTokenValue');
            input.select();
            navigator.clipboard.writeText(input.value);
            const btn = input.nextElementSibling;
            const originalContent = btn.innerHTML;
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg> Copied!`;
            btn.classList.add('btn-success');
            setTimeout(() => {
                btn.innerHTML = originalContent;
                btn.classList.remove('btn-success');
            }, 2000);
        }

        // ── Token Context Menu ─────────────────────────
        function showTokenMenu(e, id, name, isActive) {
            e.stopPropagation();
            const menu = document.getElementById('tokenContextMenu');
            const ul = menu.querySelector('ul');

            ul.innerHTML = isActive
                ? `<li><a onclick="hideTokenMenu(); toggleToken(${id}, false)" class="text-warning text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 0 0 5.636 5.636m12.728 12.728A9 9 0 0 1 5.636 5.636m12.728 12.728L5.636 5.636" /></svg>
                    Disable</a></li>`
                : `<li><a onclick="hideTokenMenu(); toggleToken(${id}, true)" class="text-success text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                    Enable</a></li>`;
            ul.innerHTML += `<li><a onclick="hideTokenMenu(); deleteToken(${id}, '${name.replace(/'/g, "\\'")}')" class="text-error text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>
                Delete</a></li>`;

            // Position the menu near the button
            const btn = e.currentTarget;
            const rect = btn.getBoundingClientRect();
            const menuW = 144; // w-36 = 9rem = 144px
            const menuH = ul.children.length * 40 + 8;

            let top = rect.bottom + 4;
            let left = rect.right - menuW;

            // Keep within viewport
            if (top + menuH > window.innerHeight) top = rect.top - menuH - 4;
            if (left < 8) left = 8;

            menu.style.top = top + 'px';
            menu.style.left = left + 'px';
            menu.classList.remove('hidden');
        }

        function hideTokenMenu() {
            document.getElementById('tokenContextMenu').classList.add('hidden');
        }

        // Close context menu on click outside or scroll
        document.addEventListener('click', hideTokenMenu);
        document.addEventListener('scroll', hideTokenMenu, true);

        async function toggleToken(id, enable) {
            const action = enable ? 'enable' : 'disable';
            await apiFetch(`${API_BASE}/tokens/${id}/${action}`, { method: 'PATCH' });
            loadTokens();
        }

        async function deleteToken(id, name) {
            if (!confirm(`Are you sure you want to delete token "${name}"?\nThis action cannot be undone.`)) return;
            await apiFetch(`${API_BASE}/tokens/${id}`, { method: 'DELETE' });
            loadTokens();
        }

        async function viewTokenDetail(id) {
            document.getElementById('tokenDetailContent').innerHTML = '<div class="flex justify-center p-8"><span class="loading loading-spinner loading-lg"></span></div>';
            document.getElementById('tokenDetailModal').showModal();

            const tokenData = await apiFetch(`${API_BASE}/tokens/${id}`);
            const analyticsData = await apiFetch(`${API_BASE}/analytics/tokens/${id}?days=30`);
            const logsData = await apiFetch(`${API_BASE}/tokens/${id}/logs?limit=20`);

            if (!tokenData || !tokenData.success) {
                document.getElementById('tokenDetailModal').close();
                return;
            }

            const t = tokenData.data;
            const a = analyticsData && analyticsData.success ? analyticsData.data : {};
            const logs = logsData && logsData.success ? logsData.data : [];
            const getIPDisplay = (data) => {
                try {
                    const list = typeof data === 'string' ? JSON.parse(data) : data;
                    return (Array.isArray(list) && list.length) ? list.join(', ') : 'Not configured (Any IP allowed)';
                } catch (e) {
                    return 'Not configured (Any IP allowed)';
                }
            };

            document.getElementById('tokenDetailTitle').textContent = t.name;
            document.getElementById('tokenDetailEnv').innerHTML = `<span class="badge badge-outline badge-sm">${t.environment}</span> &bull; Created ${new Date(t.created_at).toLocaleDateString()}`;

            document.getElementById('tokenDetailContent').innerHTML = `
                <div class="stats stats-vertical md:stats-horizontal shadow w-full mb-6">
                    <div class="stat">
                        <div class="stat-title">Total Requests</div>
                        <div class="stat-value text-lg">${(a.total_requests || 0).toLocaleString()}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-title">Success Rate</div>
                        <div class="stat-value text-lg text-success">${a.total_requests ? ((a.successful_requests / a.total_requests) * 100).toFixed(1) : 0}%</div>
                    </div>
                    <div class="stat">
                        <div class="stat-title">Failed</div>
                        <div class="stat-value text-lg text-error">${(a.failed_requests || 0).toLocaleString()}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-title">Avg Latency</div>
                        <div class="stat-value text-lg">${(a.avg_response_time_ms || 0).toFixed(0)}<span class="text-sm font-normal text-base-content/50">ms</span></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="card bg-base-200">
                        <div class="card-body">
                            <h4 class="card-title text-sm">Configuration</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span class="opacity-60">Status:</span> ${t.is_active ? '<span class="badge badge-success badge-sm">Active</span>' : '<span class="badge badge-error badge-sm">Disabled</span>'}</div>
                                <div class="flex justify-between"><span class="opacity-60">Rate Limit:</span> <span>${t.rate_limit_per_minute}/min</span></div>
                                <div class="flex justify-between"><span class="opacity-60">IP Whitelist:</span> <span>${getIPDisplay(t.ip_whitelist)}</span></div>
                                <div class="flex justify-between"><span class="opacity-60">Expires:</span> <span>${t.expires_at && t.expires_at.indexOf('0001') === -1 ? new Date(t.expires_at).toLocaleDateString() : 'Never'}</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="card bg-base-200">
                        <div class="card-body">
                            <h4 class="card-title text-sm">Usage Stats (30d)</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span class="opacity-60">Last Used:</span> <span>${t.last_used_at && t.last_used_at.indexOf('0001') === -1 ? new Date(t.last_used_at).toLocaleString() : 'Never'}</span></div>
                                <div class="flex justify-between"><span class="opacity-60">Unique IPs:</span> <span>${a.unique_ips || 0}</span></div>
                                <div class="flex justify-between"><span class="opacity-60">Unique Endpoints:</span> <span>${a.unique_endpoints || 0}</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <h4 class="font-bold text-sm mb-3">Recent Requests</h4>
                <div class="overflow-x-auto">
                    <table class="table table-xs table-zebra">
                        <thead><tr><th>Time</th><th>Method</th><th>Endpoint</th><th>Status</th><th>Latency</th><th>IP</th></tr></thead>
                        <tbody>
                            ${logs.map(l => `<tr>
                                <td class="whitespace-nowrap">${new Date(l.created_at).toLocaleString()}</td>
                                <td><span class="badge badge-ghost badge-xs font-mono">${l.method}</span></td>
                                <td class="font-mono truncate max-w-[200px]">${l.endpoint}</td>
                                <td><span class="badge badge-xs ${l.status_code < 300 ? 'badge-success' : l.status_code < 500 ? 'badge-warning' : 'badge-error'}">${l.status_code}</span></td>
                                <td>${l.response_time_ms || 0}ms</td>
                                <td class="font-mono">${l.ip_address}</td>
                            </tr>`).join('') || '<tr><td colspan="6" class="text-center text-base-content/50 py-4">No recent activity</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // ── Analytics ─────────────────────────────────
        async function loadAnalytics(days = 30) {
            const daily = await apiFetch(`${API_BASE}/analytics/daily?days=${days}`);
            if (daily && daily.success) {
                const labels = [...new Set(daily.data.map(d => formatDate(d.date)))].sort();

                const successData = labels.map(l => daily.data.filter(d => formatDate(d.date) === l).reduce((a, b) => a + b.successful_requests, 0));
                const failedData = labels.map(l => daily.data.filter(d => formatDate(d.date) === l).reduce((a, b) => a + b.failed_requests, 0));

                if (analyticsChartInstance) analyticsChartInstance.destroy();
                const ctx = document.getElementById('analyticsChart').getContext('2d');
                analyticsChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            { label: 'Success', data: successData, borderColor: chartColors.success, backgroundColor: chartColors.successFade, fill: true, tension: 0.3 },
                            { label: 'Failed', data: failedData, borderColor: chartColors.error, backgroundColor: chartColors.errorFade, fill: true, tension: 0.3 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } }
                    }
                });
            }

            const endpoints = await apiFetch(`${API_BASE}/analytics/endpoints?days=${days}&limit=20`);
            if (endpoints && endpoints.success) {
                const tbody = document.querySelector('#analyticsEndpointsTable tbody');
                tbody.innerHTML = endpoints.data.map(e =>
                    `<tr>
                        <td class="font-mono text-xs">${e.endpoint}</td>
                        <td><div class="badge badge-ghost badge-sm">${e.method}</div></td>
                        <td class="text-right font-bold">${e.request_count.toLocaleString()}</td>
                        <td class="text-right text-success">${e.successful_requests.toLocaleString()}</td>
                        <td class="text-right ${e.failed_requests > 0 ? 'text-error font-bold' : 'text-base-content/30'}">${e.failed_requests.toLocaleString()}</td>
                        <td class="text-right font-mono text-xs">${(e.avg_response_time_ms || 0).toFixed(1)}ms</td>
                    </tr>`
                ).join('') || '<tr><td colspan="6" class="text-center text-base-content/50 py-4">No data available</td></tr>';
            }
        }

        // ── Audit Logs ────────────────────────────────
        async function loadAuditLogs() {
            const data = await apiFetch(`${API_BASE}/audit-logs?limit=50`);
            if (!data || !data.success) return;
            const tbody = document.getElementById('auditBody');
            tbody.innerHTML = data.data.map(l => {
                const actionColors = {
                    create_token: 'badge-success', delete_token: 'badge-error', disable_token: 'badge-warning',
                    enable_token: 'badge-info', update_token: 'badge-primary', login: 'badge-neutral'
                };
                return `<tr class="hover">
                    <td class="whitespace-nowrap text-xs text-base-content/70">${new Date(l.created_at).toLocaleString()}</td>
                    <td><span class="badge ${actionColors[l.action] || 'badge-ghost'} badge-sm">${l.action.replace('_', ' ')}</span></td>
                    <td class="font-mono text-xs">${l.resource_type}${l.resource_id ? ' #' + l.resource_id : ''}</td>
                    <td class="text-sm max-w-xs truncate" title="${l.description}">${l.description || '-'}</td>
                    <td class="font-mono text-xs">${l.ip_address || '-'}</td>
                </tr>`;
            }).join('') || '<tr><td colspan="5" class="text-center text-base-content/50 py-8">No audit logs found</td></tr>';
        }

        window.onload = () => {
            loadDashboard();
        };
    </script>
</body>

</html>