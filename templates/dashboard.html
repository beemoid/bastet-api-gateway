<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TERMINAL // API_GATEWAY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0a0a0a;
            --primary: #33ff00;
            --primary-dim: rgba(51, 255, 0, 0.1);
            --secondary: #ffb000;
            --muted: #1f521f;
            --error: #ff3333;
            --text-shadow: 0 0 5px rgba(51, 255, 0, 0.5);
        }

        body {
            background-color: var(--bg-color);
            color: var(--primary);
            font-family: 'JetBrains Mono', monospace;
            overflow-x: hidden;
        }

        /* Scanline Overlay */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.2) 50%,
                rgba(0,0,0,0.2)
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.6;
        }

        /* Typography & Effects */
        .text-glow { text-shadow: var(--text-shadow); }
        .text-secondary { color: var(--secondary); text-shadow: 0 0 5px rgba(255, 176, 0, 0.5); }
        .text-error { color: var(--error); text-shadow: 0 0 5px rgba(255, 51, 51, 0.5); }
        .text-muted { color: var(--muted); text-shadow: none; }

        h1, h2, h3, h4, .section-header {
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Layout Primitives */
        .terminal-border {
            border: 1px solid var(--muted);
        }

        .terminal-box {
            border: 1px solid var(--muted);
            background: var(--bg-color);
            position: relative;
        }

        .terminal-header {
            border-bottom: 1px solid var(--muted);
            padding: 0.5rem 1rem;
            background: var(--primary-dim);
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .terminal-header::before { content: "[ "; color: var(--muted); }
        .terminal-header::after { content: " ]"; color: var(--muted); }

        /* Buttons */
        .btn-terminal {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 0.25rem 1rem;
            cursor: pointer;
            transition: all 0.1s;
            text-transform: uppercase;
            font-family: 'JetBrains Mono', monospace;
            display: inline-block;
        }
        .btn-terminal:hover {
            background: var(--primary);
            color: var(--bg-color);
            box-shadow: 0 0 10px var(--primary);
        }
        .btn-terminal::before { content: "["; margin-right: 0.5em; opacity: 0.5; }
        .btn-terminal::after { content: "]"; margin-left: 0.5em; opacity: 0.5; }

        .btn-sm { padding: 0.1rem 0.5rem; font-size: 0.8rem; }
        .btn-danger { border-color: var(--error); color: var(--error); }
        .btn-danger:hover { background: var(--error); color: var(--bg-color); box-shadow: 0 0 10px var(--error); }

        /* Inputs */
        input, select, textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--muted);
            color: var(--primary);
            font-family: 'JetBrains Mono', monospace;
            padding: 0.5rem;
            width: 100%;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-bottom-color: var(--primary);
            background: var(--primary-dim);
        }
        .input-group-label { color: var(--muted); font-size: 0.8rem; margin-bottom: 0.2rem; display: block; }

        /* Navigation */
        .nav-item {
            display: block;
            padding: 0.5rem 1rem;
            color: var(--muted);
            text-decoration: none;
            border-left: 2px solid transparent;
        }
        .nav-item:hover { color: var(--primary); background: var(--primary-dim); }
        .nav-item.active {
            color: var(--primary);
            border-left: 2px solid var(--primary);
            background: var(--primary-dim);
            text-shadow: var(--text-shadow);
        }
        .nav-item::before { content: "> "; opacity: 0; }
        .nav-item.active::before { opacity: 1; }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); border-left: 1px solid var(--muted); }
        ::-webkit-scrollbar-thumb { background: var(--muted); }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* Tables */
        .terminal-table { width: 100%; border-collapse: collapse; }
        .terminal-table th {
            text-align: left;
            padding: 0.5rem;
            border-bottom: 1px dashed var(--muted);
            color: var(--secondary);
            text-transform: uppercase;
            font-size: 0.8rem;
        }
        .terminal-table td { padding: 0.5rem; border-bottom: 1px solid #111; }
        .terminal-table tr:hover td { background: var(--primary-dim); }

        /* Utilities */
        .blink { animation: blink-animation 1s steps(2, start) infinite; }
        @keyframes blink-animation { to { visibility: hidden; } }

        .cursor-block {
            display: inline-block;
            width: 0.6em;
            height: 1.2em;
            background-color: var(--primary);
            vertical-align: text-bottom;
            animation: blink-animation 1s steps(2, start) infinite;
        }

        /* Modals */
        dialog {
            background: var(--bg-color);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 0;
            max-width: 800px;
            width: 90%;
            box-shadow: 0 0 20px rgba(51, 255, 0, 0.2);
        }
        dialog::backdrop { background: rgba(0,0,0,0.8); }
        .modal-header {
            background: var(--primary);
            color: var(--bg-color);
            padding: 0.5rem 1rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }
        .modal-body { padding: 1.5rem; }
        .modal-actions {
            padding: 1rem;
            border-top: 1px dashed var(--muted);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Status Badges */
        .badge { display: inline-block; padding: 0 0.5em; border: 1px solid currentColor; font-size: 0.75em; text-transform: uppercase; }
        .badge-success { color: var(--primary); border-color: var(--primary); }
        .badge-error { color: var(--error); border-color: var(--error); }
        .badge-warning { color: var(--secondary); border-color: var(--secondary); }
        .badge-dim { color: var(--muted); border-color: var(--muted); }

    </style>
</head>
<body class="h-screen flex flex-col">
    <div class="scanlines"></div>

    <!-- Top Bar -->
    <header class="border-b border-[#1f521f] p-2 flex justify-between items-center bg-[#0a0a0a] z-10">
        <div class="flex items-center gap-4">
            <span class="text-xl font-bold tracking-wider text-glow">BASTET_CLOUD // GATEWAY</span>
            <span class="badge badge-success">ONLINE</span>
        </div>
        <div class="flex items-center gap-4 text-sm">
            <span>USER: <span id="adminName" class="text-secondary">ADMIN</span></span>
            <span class="text-muted">|</span>
            <button onclick="handleLogout()" class="hover:text-white underline decoration-dashed">[ LOGOUT ]</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 border-r border-[#1f521f] flex flex-col bg-[#050505]">
            <div class="p-4 border-b border-[#1f521f] text-xs text-muted">
                MOUNT: /sys/admin
            </div>
            <nav class="flex-1 py-4">
                <a onclick="showSection('dashboard')" class="nav-item active" id="nav-dashboard">~/dashboard</a>
                <a onclick="showSection('tokens')" class="nav-item" id="nav-tokens">~/api_tokens</a>
                <a onclick="showSection('analytics')" class="nav-item" id="nav-analytics">~/analytics</a>
                <a onclick="showSection('audit')" class="nav-item" id="nav-audit">~/audit_logs</a>
            </nav>
            <div class="p-4 border-t border-[#1f521f] text-xs">
                <div class="flex justify-between text-muted mb-1">
                    <span>CPU</span>
                    <span>[|||||.....]</span>
                </div>
                <div class="flex justify-between text-muted">
                    <span>MEM</span>
                    <span>[||||......]</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-auto p-6 relative">

            <!-- Dashboard Section -->
            <div id="section-dashboard">
                <h2 class="text-2xl mb-6 flex items-center gap-2"><span class="text-secondary">></span> SYSTEM_STATUS</h2>

                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="terminal-box p-4">
                        <div class="text-xs text-muted mb-1">TOTAL_TOKENS</div>
                        <div class="text-3xl font-bold text-glow" id="stat-total">0</div>
                    </div>
                    <div class="terminal-box p-4">
                        <div class="text-xs text-muted mb-1">ACTIVE_TOKENS</div>
                        <div class="text-3xl font-bold text-glow text-secondary" id="stat-active">0</div>
                    </div>
                    <div class="terminal-box p-4">
                        <div class="text-xs text-muted mb-1">REQUESTS_24H</div>
                        <div class="text-3xl font-bold text-glow" id="stat-requests">0</div>
                    </div>
                    <div class="terminal-box p-4">
                        <div class="text-xs text-muted mb-1">SUCCESS_RATE</div>
                        <div class="text-3xl font-bold text-glow text-secondary" id="stat-success">0%</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Chart -->
                    <div class="terminal-box">
                        <div class="terminal-header">TRAFFIC_MONITOR</div>
                        <div class="p-4">
                            <canvas id="dailyChart" height="200"></canvas>
                        </div>
                    </div>

                    <!-- Top Endpoints -->
                    <div class="terminal-box">
                        <div class="terminal-header">TOP_PROCESSES</div>
                        <div class="p-0 overflow-x-auto">
                            <table class="terminal-table" id="endpointsTable">
                                <thead><tr><th>ENDPOINT</th><th>METHOD</th><th>REQS</th><th>LATENCY</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tokens Section -->
            <div id="section-tokens" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl flex items-center gap-2"><span class="text-secondary">></span> API_KEY_MANAGEMENT</h2>
                    <button onclick="showCreateTokenModal()" class="btn-terminal">INIT_NEW_KEY</button>
                </div>

                <div class="terminal-box">
                    <div class="terminal-header">KEY_REGISTRY</div>
                    <div class="overflow-x-auto">
                        <table class="terminal-table" id="tokensTable">
                            <thead>
                                <tr>
                                    <th>NAME / DESC</th>
                                    <th>HASH_FRAGMENT</th>
                                    <th>ENV</th>
                                    <th>STATUS</th>
                                    <th>USAGE</th>
                                    <th>LAST_ACCESS</th>
                                    <th>COMMANDS</th>
                                </tr>
                            </thead>
                            <tbody id="tokensBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="section-analytics" class="hidden">
                <h2 class="text-2xl mb-6 flex items-center gap-2"><span class="text-secondary">></span> NETWORK_ANALYSIS</h2>

                <div class="terminal-box mb-6">
                    <div class="terminal-header">PACKET_VOLUME</div>
                    <div class="p-4">
                        <canvas id="analyticsChart" height="300"></canvas>
                    </div>
                </div>

                <div class="terminal-box">
                    <div class="terminal-header">ENDPOINT_PERFORMANCE</div>
                    <div class="overflow-x-auto">
                        <table class="terminal-table" id="analyticsEndpointsTable">
                            <thead><tr><th>ENDPOINT</th><th>METHOD</th><th>TOTAL</th><th>ACK</th><th>ERR</th><th>AVG_MS</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Audit Logs Section -->
            <div id="section-audit" class="hidden">
                <h2 class="text-2xl mb-6 flex items-center gap-2"><span class="text-secondary">></span> SYSTEM_LOGS</h2>
                <div class="terminal-box">
                    <div class="terminal-header">VAR/LOG/AUDIT</div>
                    <div class="overflow-x-auto">
                        <table class="terminal-table" id="auditTable">
                            <thead><tr><th>TIMESTAMP</th><th>OP_CODE</th><th>TARGET</th><th>DETAILS</th><th>SRC_IP</th></tr></thead>
                            <tbody id="auditBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Create Token Modal -->
    <dialog id="createTokenModal">
        <div class="modal-header">
            <span>> NEW_TOKEN_WIZARD</span>
            <button onclick="document.getElementById('createTokenModal').close()" class="hover:text-white">X</button>
        </div>
        <form id="createTokenForm" onsubmit="handleCreateToken(event)">
            <div class="modal-body grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="input-group-label">TOKEN_IDENTIFIER *</label>
                    <input type="text" name="name" required placeholder="e.g. prod_service_01" autocomplete="off" />
                </div>
                <div>
                    <label class="input-group-label">ENVIRONMENT *</label>
                    <select name="environment" required>
                        <option value="production">PRODUCTION</option>
                        <option value="staging">STAGING</option>
                        <option value="development" selected>DEVELOPMENT</option>
                        <option value="test">TEST_SUITE</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="input-group-label">DESCRIPTION</label>
                    <textarea name="description" rows="2" placeholder="Purpose of this access key..."></textarea>
                </div>
                <div>
                    <label class="input-group-label">SCOPES (CSV)</label>
                    <input type="text" name="scopes" placeholder="read:all, write:logs" />
                </div>
                <div>
                    <label class="input-group-label">EXPIRATION</label>
                    <input type="datetime-local" name="expires_at" />
                </div>
                <div>
                    <label class="input-group-label">LIMIT_PER_MIN</label>
                    <input type="number" name="rate_limit_per_minute" value="100" />
                </div>
                <div>
                    <label class="input-group-label">LIMIT_PER_HOUR</label>
                    <input type="number" name="rate_limit_per_hour" value="5000" />
                </div>
                <div class="md:col-span-2">
                    <label class="input-group-label">IP_WHITELIST (CIDR/IP)</label>
                    <input type="text" name="ip_whitelist" placeholder="10.0.0.0/8, 192.168.1.5" />
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-terminal btn-danger" onclick="document.getElementById('createTokenModal').close()">CANCEL</button>
                <button type="submit" class="btn-terminal">GENERATE_TOKEN</button>
            </div>
        </form>
    </dialog>

    <!-- Token Created Modal -->
    <dialog id="tokenCreatedModal">
        <div class="modal-header">
            <span class="text-[#0a0a0a]">SUCCESS</span>
            <!-- Inverted header for success -->
            <style>#tokenCreatedModal .modal-header { background: var(--primary); color: black; }</style>
        </div>
        <div class="modal-body">
            <div class="border border-yellow-500 p-4 mb-4 text-yellow-500 text-sm">
                [WARNING]: SECRET KEY VISIBLE. COPY IMMEDIATELY. CANNOT BE RETRIEVED LATER.
            </div>
            <div class="mb-4">
                <label class="input-group-label">ACCESS_TOKEN</label>
                <div class="flex gap-2">
                    <input type="text" id="newTokenValue" readonly class="font-bold text-lg" />
                    <button class="btn-terminal" onclick="copyToken()">COPY</button>
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-terminal" onclick="document.getElementById('tokenCreatedModal').close(); loadTokens();">ACKNOWLEDGE</button>
        </div>
    </dialog>

    <!-- Token Detail Modal -->
    <dialog id="tokenDetailModal">
        <div class="modal-header">
            <span id="tokenDetailTitle">TOKEN_DETAILS</span>
            <button onclick="document.getElementById('tokenDetailModal').close()" class="hover:text-white">X</button>
        </div>
        <div class="modal-body" id="tokenDetailContent"></div>
        <div class="modal-actions">
            <button class="btn-terminal" onclick="document.getElementById('tokenDetailModal').close()">CLOSE_WINDOW</button>
        </div>
    </dialog>

    <script>
        const API_BASE = '/api/v1/admin';
        let dailyChartInstance = null;
        let analyticsChartInstance = null;

        // Chart Global Defaults
        Chart.defaults.color = '#1f521f';
        Chart.defaults.font.family = '"JetBrains Mono", monospace';
        Chart.defaults.borderColor = '#1f521f';

        function getHeaders() {
            const token = localStorage.getItem('session_token');
            return {
                'Content-Type': 'application/json',
                'X-Session-Token': token || ''
            };
        }

        async function apiFetch(url, options = {}) {
            options.headers = { ...getHeaders(), ...options.headers };
            const resp = await fetch(url, options);
            if (resp.status === 401) {
                localStorage.removeItem('session_token');
                window.location.href = '/admin/login';
                return null;
            }
            return resp.json();
        }

        // Auth check
        if (!localStorage.getItem('session_token')) {
            window.location.href = '/admin/login';
        }

        // Show admin name
        try {
            const user = JSON.parse(localStorage.getItem('admin_user') || '{}');
            document.getElementById('adminName').textContent = (user.username || 'ROOT').toUpperCase();
        } catch(e) {}

        async function handleLogout() {
            await apiFetch(`${API_BASE}/auth/logout`, { method: 'POST' });
            localStorage.removeItem('session_token');
            localStorage.removeItem('admin_user');
            window.location.href = '/admin/login';
        }

        // Navigation
        function showSection(section) {
            ['dashboard', 'tokens', 'analytics', 'audit'].forEach(s => {
                document.getElementById(`section-${s}`).classList.toggle('hidden', s !== section);
                document.getElementById(`nav-${s}`).classList.toggle('active', s === section);
            });
            if (section === 'dashboard') loadDashboard();
            if (section === 'tokens') loadTokens();
            if (section === 'analytics') loadAnalytics();
            if (section === 'audit') loadAuditLogs();
        }

        // Dashboard
        async function loadDashboard() {
            const data = await apiFetch(`${API_BASE}/analytics/dashboard`);
            if (!data || !data.success) return;
            const s = data.data;
            document.getElementById('stat-total').textContent = s.total_tokens || 0;
            document.getElementById('stat-active').textContent = s.active_tokens || 0;
            document.getElementById('stat-requests').textContent = (s.total_requests_24h || 0).toLocaleString();
            document.getElementById('stat-success').textContent = (s.success_rate || 0).toFixed(1) + '%';

            // Load daily chart
            const daily = await apiFetch(`${API_BASE}/analytics/daily?days=7`);
            if (daily && daily.success && daily.data.length > 0) {
                const labels = [...new Set(daily.data.map(d => d.date))].sort();
                const counts = labels.map(l => daily.data.filter(d => d.date === l).reduce((a, b) => a + b.request_count, 0));
                renderDailyChart(labels, counts);
            }

            // Load endpoints
            const endpoints = await apiFetch(`${API_BASE}/analytics/endpoints?days=7&limit=10`);
            if (endpoints && endpoints.success) {
                const tbody = document.querySelector('#endpointsTable tbody');
                tbody.innerHTML = endpoints.data.map(e =>
                    `<tr>
                        <td class="font-bold">${e.endpoint}</td>
                        <td><span class="badge badge-dim">${e.method}</span></td>
                        <td>${e.request_count}</td>
                        <td>${(e.avg_response_time_ms || 0).toFixed(0)}ms</td>
                    </tr>`
                ).join('') || '<tr><td colspan="4" class="text-center text-muted">-- NO DATA --</td></tr>';
            }
        }

        function renderDailyChart(labels, data) {
            if (dailyChartInstance) dailyChartInstance.destroy();
            const ctx = document.getElementById('dailyChart').getContext('2d');
            dailyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'REQUESTS',
                        data,
                        backgroundColor: '#33ff00',
                        borderColor: '#33ff00',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false } },
                        y: {
                            beginAtZero: true,
                            grid: { color: '#1f521f', tickLength: 0 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Tokens
        async function loadTokens() {
            const data = await apiFetch(`${API_BASE}/tokens`);
            if (!data || !data.success) return;
            const tbody = document.getElementById('tokensBody');
            tbody.innerHTML = data.data.map(t => {
                const statusBadge = t.is_active
                    ? '<span class="badge badge-success">ACTIVE</span>'
                    : '<span class="badge badge-error">DISABLED</span>';
                const envBadge = {
                    production: 'badge-warning',
                    staging: 'badge-dim',
                    development: 'badge-dim',
                    test: 'badge-dim'
                }[t.environment] || 'badge-dim';

                const lastUsed = t.last_used_at && t.last_used_at !== '0001-01-01T00:00:00Z' ? new Date(t.last_used_at).toLocaleDateString() : 'NEVER';

                return `<tr>
                    <td>
                        <div class="font-bold">${t.name}</div>
                        <div class="text-xs text-muted">${t.description || ''}</div>
                    </td>
                    <td class="font-mono text-xs opacity-70">${t.token}</td>
                    <td><span class="badge ${envBadge}">${t.environment.toUpperCase()}</span></td>
                    <td>${statusBadge}</td>
                    <td>${(t.total_requests || 0).toLocaleString()}</td>
                    <td class="text-sm">${lastUsed}</td>
                    <td>
                        <div class="flex gap-2">
                            <button class="btn-terminal btn-sm" onclick="viewTokenDetail(${t.id})">INFO</button>
                            ${t.is_active
                                ? `<button class="btn-terminal btn-sm btn-danger" onclick="toggleToken(${t.id}, false)">DISABLE</button>`
                                : `<button class="btn-terminal btn-sm" onclick="toggleToken(${t.id}, true)">ENABLE</button>`}
                            <button class="btn-terminal btn-sm btn-danger" onclick="deleteToken(${t.id}, '${t.name}')">DEL</button>
                        </div>
                    </td>
                </tr>`;
            }).join('') || '<tr><td colspan="7" class="text-center py-8 text-muted">NO KEYS FOUND. INITIATE NEW KEY GENERATION.</td></tr>';
        }

        function showCreateTokenModal() {
            document.getElementById('createTokenForm').reset();
            document.getElementById('createTokenModal').showModal();
        }

        async function handleCreateToken(e) {
            e.preventDefault();
            const form = new FormData(e.target);
            const body = {
                name: form.get('name'),
                description: form.get('description'),
                environment: form.get('environment'),
                scopes: form.get('scopes') ? form.get('scopes').split(',').map(s => s.trim()).filter(Boolean) : [],
                ip_whitelist: form.get('ip_whitelist') ? form.get('ip_whitelist').split(',').map(s => s.trim()).filter(Boolean) : [],
                rate_limit_per_minute: parseInt(form.get('rate_limit_per_minute')) || 100,
                rate_limit_per_hour: parseInt(form.get('rate_limit_per_hour')) || 5000,
                rate_limit_per_day: 100000
            };
            if (form.get('expires_at')) {
                body.expires_at = new Date(form.get('expires_at')).toISOString();
            }

            const data = await apiFetch(`${API_BASE}/tokens`, { method: 'POST', body: JSON.stringify(body) });
            if (!data) return;
            document.getElementById('createTokenModal').close();

            if (data.success) {
                document.getElementById('newTokenValue').value = data.data.token;
                document.getElementById('tokenCreatedModal').showModal();
            } else {
                alert(data.message || 'Failed to create token');
            }
        }

        function copyToken() {
            const input = document.getElementById('newTokenValue');
            input.select();
            navigator.clipboard.writeText(input.value);
            const btn = input.nextElementSibling;
            btn.textContent = 'COPIED!';
            setTimeout(() => btn.textContent = 'COPY', 2000);
        }

        async function toggleToken(id, enable) {
            const action = enable ? 'enable' : 'disable';
            await apiFetch(`${API_BASE}/tokens/${id}/${action}`, { method: 'PATCH' });
            loadTokens();
        }

        async function deleteToken(id, name) {
            if (!confirm(`CONFIRM DELETION: "${name}"? ACTION IRREVERSIBLE.`)) return;
            await apiFetch(`${API_BASE}/tokens/${id}`, { method: 'DELETE' });
            loadTokens();
        }

        async function viewTokenDetail(id) {
            const tokenData = await apiFetch(`${API_BASE}/tokens/${id}`);
            const analyticsData = await apiFetch(`${API_BASE}/analytics/tokens/${id}?days=30`);
            const logsData = await apiFetch(`${API_BASE}/tokens/${id}/logs?limit=20`);

            if (!tokenData || !tokenData.success) return;
            const t = tokenData.data;
            const a = analyticsData && analyticsData.success ? analyticsData.data : {};
            const logs = logsData && logsData.success ? logsData.data : [];

            document.getElementById('tokenDetailTitle').textContent = `DETAILS: ${t.name}`;
            document.getElementById('tokenDetailContent').innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="terminal-box p-3 text-center">
                        <div class="text-xs text-muted">REQUESTS</div>
                        <div class="text-xl font-bold">${(a.total_requests || 0).toLocaleString()}</div>
                    </div>
                    <div class="terminal-box p-3 text-center">
                        <div class="text-xs text-muted">SUCCESS</div>
                        <div class="text-xl font-bold text-[#33ff00]">${(a.successful_requests || 0).toLocaleString()}</div>
                    </div>
                    <div class="terminal-box p-3 text-center">
                        <div class="text-xs text-muted">FAILED</div>
                        <div class="text-xl font-bold text-[#ff3333]">${(a.failed_requests || 0).toLocaleString()}</div>
                    </div>
                    <div class="terminal-box p-3 text-center">
                        <div class="text-xs text-muted">AVG_LATENCY</div>
                        <div class="text-xl font-bold">${(a.avg_response_time_ms || 0).toFixed(0)}ms</div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-sm">
                    <div><span class="text-muted">ENV:</span> <span class="badge badge-dim">${t.environment}</span></div>
                    <div><span class="text-muted">STATUS:</span> ${t.is_active ? '<span class="badge badge-success">ACTIVE</span>' : '<span class="badge badge-error">DISABLED</span>'}</div>
                    <div><span class="text-muted">CREATED:</span> ${new Date(t.created_at).toLocaleString()}</div>
                    <div><span class="text-muted">LIMITS:</span> ${t.rate_limit_per_minute}/min</div>
                    <div><span class="text-muted">UNIQUE_IPS:</span> ${a.unique_ips || 0}</div>
                    <div><span class="text-muted">UNIQUE_EPS:</span> ${a.unique_endpoints || 0}</div>
                </div>
                <h4 class="mb-2 border-b border-[#1f521f]">RECENT_ACTIVITY_LOG</h4>
                <div class="overflow-x-auto max-h-60 overflow-y-auto">
                    <table class="terminal-table text-xs">
                        <thead><tr><th>TIME</th><th>METHOD</th><th>PATH</th><th>CODE</th><th>MS</th><th>IP</th></tr></thead>
                        <tbody>
                            ${logs.map(l => `<tr>
                                <td>${new Date(l.created_at).toLocaleTimeString()}</td>
                                <td>${l.method}</td>
                                <td>${l.endpoint}</td>
                                <td><span class="badge ${l.status_code < 300 ? 'badge-success' : l.status_code < 500 ? 'badge-warning' : 'badge-error'}">${l.status_code}</span></td>
                                <td>${l.response_time_ms || 0}</td>
                                <td>${l.ip_address}</td>
                            </tr>`).join('') || '<tr><td colspan="6" class="text-center text-muted">NO LOGS</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('tokenDetailModal').showModal();
        }

        // Analytics
        async function loadAnalytics() {
            const daily = await apiFetch(`${API_BASE}/analytics/daily?days=30`);
            if (daily && daily.success && daily.data.length > 0) {
                const labels = [...new Set(daily.data.map(d => d.date))].sort();
                const success = labels.map(l => daily.data.filter(d => d.date === l).reduce((a, b) => a + b.successful_requests, 0));
                const failed = labels.map(l => daily.data.filter(d => d.date === l).reduce((a, b) => a + b.failed_requests, 0));

                if (analyticsChartInstance) analyticsChartInstance.destroy();
                const ctx = document.getElementById('analyticsChart').getContext('2d');
                analyticsChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: 'SUCCESS',
                                data: success,
                                borderColor: '#33ff00',
                                backgroundColor: 'rgba(51, 255, 0, 0.1)',
                                tension: 0, // No curves
                                pointRadius: 0,
                                fill: true,
                                borderWidth: 1
                            },
                            {
                                label: 'FAILED',
                                data: failed,
                                borderColor: '#ff3333',
                                backgroundColor: 'rgba(255, 51, 51, 0.1)',
                                tension: 0,
                                pointRadius: 0,
                                fill: true,
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { grid: { display: false } },
                            y: { grid: { color: '#1f521f' }, beginAtZero: true }
                        },
                        interaction: { mode: 'index', intersect: false },
                        plugins: { legend: { display: true, labels: { font: { family: 'JetBrains Mono' } } } }
                    }
                });
            }

            const endpoints = await apiFetch(`${API_BASE}/analytics/endpoints?days=30&limit=20`);
            if (endpoints && endpoints.success) {
                const tbody = document.querySelector('#analyticsEndpointsTable tbody');
                tbody.innerHTML = endpoints.data.map(e =>
                    `<tr>
                        <td class="font-bold">${e.endpoint}</td>
                        <td>${e.method}</td>
                        <td>${e.request_count}</td>
                        <td class="text-[#33ff00]">${e.successful_requests}</td>
                        <td class="text-[#ff3333]">${e.failed_requests}</td>
                        <td>${(e.avg_response_time_ms || 0).toFixed(1)}</td>
                    </tr>`
                ).join('') || '<tr><td colspan="6" class="text-center text-muted">NO DATA</td></tr>';
            }
        }

        // Audit Logs
        async function loadAuditLogs() {
            const data = await apiFetch(`${API_BASE}/audit-logs?limit=100`);
            if (!data || !data.success) return;
            const tbody = document.getElementById('auditBody');
            tbody.innerHTML = data.data.map(l => {
                const actionBadge = {
                    create_token: 'badge-success', delete_token: 'badge-error', disable_token: 'badge-warning',
                    enable_token: 'badge-warning', update_token: 'badge-dim'
                }[l.action] || 'badge-dim';
                return `<tr>
                    <td class="text-xs text-muted">${new Date(l.created_at).toLocaleString()}</td>
                    <td><span class="badge ${actionBadge}">${l.action.toUpperCase()}</span></td>
                    <td>${l.resource_type}${l.resource_id ? ' #' + l.resource_id : ''}</td>
                    <td class="text-sm">${l.description || '-'}</td>
                    <td class="text-xs">${l.ip_address || '-'}</td>
                </tr>`;
            }).join('') || '<tr><td colspan="5" class="text-center text-muted">NO LOGS</td></tr>';
        }

        // Initial load
        loadDashboard();
    </script>
</body>
</html>
