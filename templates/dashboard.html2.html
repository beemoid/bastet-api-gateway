<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bastet Cloud // API Gateway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Fonts: Calistoga (Display), Inter (UI), JetBrains Mono (Technical) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Calistoga&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            /* Design Tokens */
            --background: #FAFAFA;
            --foreground: #0F172A; /* Slate-900 */
            --muted: #F1F5F9;      /* Slate-100 */
            --muted-foreground: #64748B; /* Slate-500 */
            --border: #E2E8F0;     /* Slate-200 */
            --card: #FFFFFF;

            /* Electric Blue Gradient */
            --accent: #0052FF;
            --accent-secondary: #4D7CFF;
            --accent-foreground: #FFFFFF;
        }

        body {
            background-color: var(--background);
            color: var(--foreground);
            font-family: 'Inter', system-ui, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* Typography */
        h1, h2, h3, .font-display { font-family: 'Calistoga', serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Gradient Utilities */
        .bg-gradient-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
        }

        .text-gradient {
            background: linear-gradient(to right, var(--accent), var(--accent-secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* Animations */
        .animate-fade-in { animation: fadeIn 0.7s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }
        .delay-300 { animation-delay: 0.3s; }

        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

        .hover-lift { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .hover-lift:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }

        .pulse-dot {
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 82, 255, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(0, 82, 255, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 82, 255, 0); }
        }

        /* Components */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 1rem; /* rounded-2xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .btn-primary {
            background: linear-gradient(to right, var(--accent), var(--accent-secondary));
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* rounded-xl */
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 4px 14px 0 rgba(0, 82, 255, 0.25);
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 82, 255, 0.35);
        }
        .btn-primary:active { transform: scale(0.98); }

        .btn-ghost {
            color: var(--muted-foreground);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .btn-ghost:hover {
            background: var(--muted);
            color: var(--foreground);
        }

        .input-modern {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border);
            background: transparent;
            transition: all 0.2s;
        }
        .input-modern:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(0, 82, 255, 0.1);
        }

        /* Sidebar Navigation */
        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            color: var(--muted-foreground);
            transition: all 0.2s;
            font-weight: 500;
        }
        .nav-link:hover {
            background: var(--muted);
            color: var(--foreground);
        }
        .nav-link.active {
            background: rgba(0, 82, 255, 0.08);
            color: var(--accent);
        }
        .nav-link.active i { color: var(--accent); }

        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.025em;
            text-transform: uppercase;
        }
        .badge-success { background: #DCFCE7; color: #166534; border: 1px solid #BBF7D0; }
        .badge-warning { background: #FEF9C3; color: #854D0E; border: 1px solid #FEF08A; }
        .badge-error { background: #FEE2E2; color: #991B1B; border: 1px solid #FECACA; }
        .badge-neutral { background: var(--muted); color: var(--muted-foreground); border: 1px solid var(--border); }

        /* Dialog */
        dialog {
            border: none;
            border-radius: 1.5rem;
            background: var(--card);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 0;
            max-width: 42rem;
            width: 90%;
        }
        dialog::backdrop {
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(4px);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-20 shadow-sm">
        <div class="p-8 pb-4">
            <div class="flex items-center gap-3 mb-8">
                <div class="w-10 h-10 rounded-xl bg-gradient-primary flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
                    <i data-lucide="zap" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="font-display text-xl leading-none">Bastet</h1>
                    <span class="text-xs text-slate-400 font-mono tracking-wider">CLOUD GATEWAY</span>
                </div>
            </div>

            <div class="flex flex-col gap-1">
                <a onclick="showSection('dashboard')" class="nav-link active cursor-pointer" id="nav-dashboard">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i> Dashboard
                </a>
                <a onclick="showSection('tokens')" class="nav-link cursor-pointer" id="nav-tokens">
                    <i data-lucide="key" class="w-5 h-5"></i> API Tokens
                </a>
                <a onclick="showSection('analytics')" class="nav-link cursor-pointer" id="nav-analytics">
                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i> Analytics
                </a>
                <a onclick="showSection('audit')" class="nav-link cursor-pointer" id="nav-audit">
                    <i data-lucide="file-text" class="w-5 h-5"></i> Audit Logs
                </a>
            </div>
        </div>

        <div class="mt-auto p-6 border-t border-slate-100">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold">
                    <i data-lucide="user" class="w-5 h-5"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div id="adminName" class="font-medium text-sm truncate">Admin</div>
                    <div class="text-xs text-slate-400">Administrator</div>
                </div>
                <button onclick="handleLogout()" class="p-2 text-slate-400 hover:text-red-500 transition-colors rounded-lg hover:bg-red-50" title="Logout">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-[#FAFAFA] p-8 lg:p-12 relative">
        <!-- Radial Glow Effect -->
        <div class="fixed top-0 right-0 w-[500px] h-[500px] bg-blue-500/5 blur-[120px] rounded-full pointer-events-none -z-10"></div>

        <!-- Dashboard Section -->
        <div id="section-dashboard" class="animate-fade-in space-y-8 max-w-6xl mx-auto">
            <header class="flex justify-between items-end">
                <div>
                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-50 border border-blue-100 mb-4">
                        <span class="w-2 h-2 rounded-full bg-blue-600 pulse-dot"></span>
                        <span class="text-[10px] font-mono font-bold text-blue-600 tracking-wider uppercase">System Status</span>
                    </div>
                    <h2 class="text-4xl font-display text-slate-900">Dashboard <span class="text-gradient">Overview</span></h2>
                </div>
                <div class="text-sm text-slate-500 font-medium">Last updated: <span id="lastUpdated">Just now</span></div>
            </header>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card p-6 hover-lift">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-2 bg-blue-50 rounded-lg text-blue-600"><i data-lucide="key" class="w-5 h-5"></i></div>
                        <span class="text-xs font-mono text-slate-400 bg-slate-50 px-2 py-1 rounded">TOTAL</span>
                    </div>
                    <div class="text-3xl font-display font-bold text-slate-900 mb-1" id="stat-total">0</div>
                    <div class="text-sm text-slate-500">Total API Tokens</div>
                </div>

                <div class="card p-6 hover-lift delay-100">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-2 bg-green-50 rounded-lg text-green-600"><i data-lucide="activity" class="w-5 h-5"></i></div>
                        <span class="badge badge-success text-[10px]">Active</span>
                    </div>
                    <div class="text-3xl font-display font-bold text-slate-900 mb-1" id="stat-active">0</div>
                    <div class="text-sm text-slate-500">Active Tokens</div>
                </div>

                <div class="card p-6 hover-lift delay-200">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-2 bg-purple-50 rounded-lg text-purple-600"><i data-lucide="bar-chart" class="w-5 h-5"></i></div>
                        <span class="text-xs font-mono text-slate-400 bg-slate-50 px-2 py-1 rounded">24H</span>
                    </div>
                    <div class="text-3xl font-display font-bold text-slate-900 mb-1" id="stat-requests">0</div>
                    <div class="text-sm text-slate-500">Total Requests</div>
                </div>

                <div class="card p-6 hover-lift delay-300">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-2 bg-orange-50 rounded-lg text-orange-600"><i data-lucide="shield-check" class="w-5 h-5"></i></div>
                    </div>
                    <div class="text-3xl font-display font-bold text-slate-900 mb-1" id="stat-success">0%</div>
                    <div class="text-sm text-slate-500">Success Rate</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main Chart -->
                <div class="lg:col-span-2 card p-8">
                    <h3 class="text-lg font-semibold mb-6 flex items-center gap-2">
                        <i data-lucide="trending-up" class="w-5 h-5 text-blue-600"></i> Traffic Overview
                    </h3>
                    <canvas id="dailyChart" height="250"></canvas>
                </div>

                <!-- Top Endpoints -->
                <div class="card p-0 overflow-hidden flex flex-col">
                    <div class="p-6 border-b border-slate-100 bg-slate-50/50">
                        <h3 class="font-semibold">Top Endpoints</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left" id="endpointsTable">
                            <thead class="text-xs text-slate-400 uppercase bg-slate-50/50">
                                <tr>
                                    <th class="px-6 py-3 font-medium">Path</th>
                                    <th class="px-6 py-3 font-medium">Reqs</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tokens Section -->
        <div id="section-tokens" class="hidden animate-fade-in space-y-8 max-w-6xl mx-auto">
            <header class="flex justify-between items-end">
                <div>
                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-50 border border-blue-100 mb-4">
                        <span class="w-2 h-2 rounded-full bg-blue-600"></span>
                        <span class="text-[10px] font-mono font-bold text-blue-600 tracking-wider uppercase">Access Control</span>
                    </div>
                    <h2 class="text-4xl font-display text-slate-900">API <span class="text-gradient">Tokens</span></h2>
                </div>
                <button onclick="showCreateTokenModal()" class="btn-primary flex items-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i> Create Token
                </button>
            </header>

            <div class="card overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-semibold border-b border-slate-200">
                            <tr>
                                <th class="px-6 py-4">Name / Desc</th>
                                <th class="px-6 py-4">Hash</th>
                                <th class="px-6 py-4">Environment</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4">Usage</th>
                                <th class="px-6 py-4">Last Used</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tokensBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="section-analytics" class="hidden animate-fade-in space-y-8 max-w-6xl mx-auto">
            <header>
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-50 border border-blue-100 mb-4">
                    <span class="w-2 h-2 rounded-full bg-blue-600"></span>
                    <span class="text-[10px] font-mono font-bold text-blue-600 tracking-wider uppercase">Insights</span>
                </div>
                <h2 class="text-4xl font-display text-slate-900">Network <span class="text-gradient">Analytics</span></h2>
            </header>

            <div class="card p-8">
                <h3 class="text-lg font-semibold mb-6">Request Volume (30 Days)</h3>
                <canvas id="analyticsChart" height="300"></canvas>
            </div>

            <div class="card overflow-hidden">
                <div class="p-6 border-b border-slate-100">
                    <h3 class="font-semibold">Endpoint Performance</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left" id="analyticsEndpointsTable">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-50">
                            <tr>
                                <th class="px-6 py-3">Endpoint</th>
                                <th class="px-6 py-3">Method</th>
                                <th class="px-6 py-3">Total</th>
                                <th class="px-6 py-3 text-green-600">Success</th>
                                <th class="px-6 py-3 text-red-600">Failed</th>
                                <th class="px-6 py-3">Avg Latency</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Audit Logs Section -->
        <div id="section-audit" class="hidden animate-fade-in space-y-8 max-w-6xl mx-auto">
            <header>
                 <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-50 border border-blue-100 mb-4">
                    <span class="w-2 h-2 rounded-full bg-blue-600"></span>
                    <span class="text-[10px] font-mono font-bold text-blue-600 tracking-wider uppercase">Security</span>
                </div>
                <h2 class="text-4xl font-display text-slate-900">Audit <span class="text-gradient">Logs</span></h2>
            </header>
            <div class="card overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left" id="auditTable">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="px-6 py-3">Timestamp</th>
                                <th class="px-6 py-3">Action</th>
                                <th class="px-6 py-3">Resource</th>
                                <th class="px-6 py-3">Details</th>
                                <th class="px-6 py-3">IP Address</th>
                            </tr>
                        </thead>
                        <tbody id="auditBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Create Token Modal -->
    <dialog id="createTokenModal" class="backdrop:backdrop-blur-sm">
        <div class="p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-display font-bold">Create New Token</h3>
                <button onclick="document.getElementById('createTokenModal').close()" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-slate-500"></i>
                </button>
            </div>

            <form id="createTokenForm" onsubmit="handleCreateToken(event)" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-slate-700">Token Name <span class="text-red-500">*</span></label>
                        <input type="text" name="name" class="input-modern" required placeholder="e.g. Production Service A" />
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-slate-700">Environment <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <select name="environment" class="input-modern appearance-none cursor-pointer" required>
                                <option value="production">Production</option>
                                <option value="staging">Staging</option>
                                <option value="development" selected>Development</option>
                                <option value="test">Test</option>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>
                    <div class="md:col-span-2 space-y-2">
                        <label class="text-sm font-medium text-slate-700">Description</label>
                        <textarea name="description" class="input-modern" rows="2" placeholder="What will this token be used for?"></textarea>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-slate-700">Scopes (Comma separated)</label>
                        <input type="text" name="scopes" class="input-modern" placeholder="read:all, write:logs" />
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-slate-700">Expiration (Optional)</label>
                        <input type="datetime-local" name="expires_at" class="input-modern" />
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-slate-700">Rate Limit (Per Minute)</label>
                        <input type="number" name="rate_limit_per_minute" class="input-modern" value="100" />
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-slate-700">Rate Limit (Per Hour)</label>
                        <input type="number" name="rate_limit_per_hour" class="input-modern" value="5000" />
                    </div>
                     <div class="md:col-span-2 space-y-2">
                        <label class="text-sm font-medium text-slate-700">IP Whitelist (CIDR or IP)</label>
                        <input type="text" name="ip_whitelist" class="input-modern" placeholder="10.0.0.0/8, 192.168.1.5" />
                        <p class="text-xs text-slate-500">Leave empty to allow all IPs.</p>
                    </div>
                </div>

                <div class="pt-6 border-t border-slate-100 flex justify-end gap-3">
                    <button type="button" class="btn-ghost" onclick="document.getElementById('createTokenModal').close()">Cancel</button>
                    <button type="submit" class="btn-primary">Generate Token</button>
                </div>
            </form>
        </div>
    </dialog>

    <!-- Token Created Modal -->
    <dialog id="tokenCreatedModal" class="backdrop:backdrop-blur-sm">
        <div class="p-8 text-center max-w-lg mx-auto">
            <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="check" class="w-8 h-8"></i>
            </div>
            <h3 class="text-2xl font-display font-bold mb-2">Token Generated!</h3>
            <p class="text-slate-500 mb-6">Please copy your access token now. You won't be able to see it again.</p>

            <div class="bg-slate-50 border border-slate-200 rounded-xl p-4 mb-6 flex items-center gap-3">
                <input type="text" id="newTokenValue" readonly class="flex-1 bg-transparent font-mono text-sm text-slate-700 focus:outline-none" />
                <button onclick="copyToken()" class="text-blue-600 hover:text-blue-700 font-medium text-sm">Copy</button>
            </div>

            <button class="btn-primary w-full" onclick="document.getElementById('tokenCreatedModal').close(); loadTokens();">I have saved the token</button>
        </div>
    </dialog>

    <!-- Token Detail Modal -->
    <dialog id="tokenDetailModal" class="backdrop:backdrop-blur-sm">
        <div class="p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-display font-bold" id="tokenDetailTitle">Token Details</h3>
                <button onclick="document.getElementById('tokenDetailModal').close()" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-slate-500"></i>
                </button>
            </div>
            <div id="tokenDetailContent" class="space-y-6"></div>
        </div>
    </dialog>

    <script>
        // --- Icons ---
        lucide.createIcons();

        // --- Logic ---
        const API_BASE = '/api/v1/admin';
        let dailyChartInstance = null;
        let analyticsChartInstance = null;

        // Chart defaults
        Chart.defaults.font.family = "'Inter', system-ui, sans-serif";
        Chart.defaults.color = '#64748B';
        Chart.defaults.scale.grid.color = '#F1F5F9';

        function getHeaders() {
            const token = localStorage.getItem('session_token');
            return {
                'Content-Type': 'application/json',
                'X-Session-Token': token || ''
            };
        }

        async function apiFetch(url, options = {}) {
            options.headers = { ...getHeaders(), ...options.headers };
            const resp = await fetch(url, options);
            if (resp.status === 401) {
                localStorage.removeItem('session_token');
                window.location.href = '/admin/login';
                return null;
            }
            return resp.json();
        }

        // Auth check
        if (!localStorage.getItem('session_token')) {
            window.location.href = '/admin/login';
        }

        // Admin Name
        try {
            const user = JSON.parse(localStorage.getItem('admin_user') || '{}');
            document.getElementById('adminName').textContent = user.username || 'Admin';
        } catch(e) {}

        async function handleLogout() {
            await apiFetch(`${API_BASE}/auth/logout`, { method: 'POST' });
            localStorage.removeItem('session_token');
            localStorage.removeItem('admin_user');
            window.location.href = '/admin/login';
        }

        // Navigation
        function showSection(section) {
            ['dashboard', 'tokens', 'analytics', 'audit'].forEach(s => {
                const el = document.getElementById(`section-${s}`);
                const nav = document.getElementById(`nav-${s}`);
                if (s === section) {
                    el.classList.remove('hidden');
                    nav.classList.add('active');
                } else {
                    el.classList.add('hidden');
                    nav.classList.remove('active');
                }
            });
            if (section === 'dashboard') loadDashboard();
            if (section === 'tokens') loadTokens();
            if (section === 'analytics') loadAnalytics();
            if (section === 'audit') loadAuditLogs();
        }

        // Dashboard
        async function loadDashboard() {
            const data = await apiFetch(`${API_BASE}/analytics/dashboard`);
            if (!data || !data.success) return;
            const s = data.data;
            document.getElementById('stat-total').textContent = s.total_tokens || 0;
            document.getElementById('stat-active').textContent = s.active_tokens || 0;
            document.getElementById('stat-requests').textContent = (s.total_requests_24h || 0).toLocaleString();
            document.getElementById('stat-success').textContent = (s.success_rate || 0).toFixed(1) + '%';
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();

            // Daily Chart
            const daily = await apiFetch(`${API_BASE}/analytics/daily?days=7`);
            if (daily && daily.success && daily.data.length > 0) {
                const labels = [...new Set(daily.data.map(d => d.date))].sort();
                const counts = labels.map(l => daily.data.filter(d => d.date === l).reduce((a, b) => a + b.request_count, 0));

                if (dailyChartInstance) dailyChartInstance.destroy();
                const ctx = document.getElementById('dailyChart').getContext('2d');
                dailyChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Requests',
                            data: counts,
                            borderColor: '#0052FF',
                            backgroundColor: (context) => {
                                const ctx = context.chart.ctx;
                                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                                gradient.addColorStop(0, 'rgba(0, 82, 255, 0.2)');
                                gradient.addColorStop(1, 'rgba(0, 82, 255, 0)');
                                return gradient;
                            },
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, border: { display: false } }, x: { grid: { display: false } } }
                    }
                });
            }

            // Top Endpoints
            const endpoints = await apiFetch(`${API_BASE}/analytics/endpoints?days=7&limit=5`);
            if (endpoints && endpoints.success) {
                const tbody = document.querySelector('#endpointsTable tbody');
                tbody.innerHTML = endpoints.data.map(e => `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-6 py-4 font-mono text-xs text-slate-600 truncate max-w-[200px]" title="${e.endpoint}">
                            <span class="inline-block px-2 py-0.5 rounded bg-slate-100 text-slate-500 mr-2 font-bold">${e.method}</span>
                            ${e.endpoint}
                        </td>
                        <td class="px-6 py-4 font-medium text-slate-900">${e.request_count.toLocaleString()}</td>
                    </tr>
                `).join('') || '<tr><td colspan="2" class="px-6 py-4 text-center text-slate-500">No data available</td></tr>';
            }
        }

        // Tokens
        async function loadTokens() {
            const data = await apiFetch(`${API_BASE}/tokens`);
            if (!data || !data.success) return;
            const tbody = document.getElementById('tokensBody');

            tbody.innerHTML = data.data.map(t => {
                const statusBadge = t.is_active
                    ? '<span class="badge badge-success">Active</span>'
                    : '<span class="badge badge-neutral">Disabled</span>';

                const envClass = {
                    production: 'badge-warning',
                    staging: 'badge-neutral',
                    development: 'badge-neutral',
                    test: 'badge-neutral'
                }[t.environment] || 'badge-neutral';

                const lastUsed = t.last_used_at && t.last_used_at !== '0001-01-01T00:00:00Z' ? new Date(t.last_used_at).toLocaleDateString() : 'Never';

                return `
                <tr class="hover:bg-slate-50 transition-colors group">
                    <td class="px-6 py-4">
                        <div class="font-medium text-slate-900">${t.name}</div>
                        <div class="text-xs text-slate-500 truncate max-w-[200px]">${t.description || ''}</div>
                    </td>
                    <td class="px-6 py-4 font-mono text-xs text-slate-500">${t.token}</td>
                    <td class="px-6 py-4"><span class="badge ${envClass}">${t.environment}</span></td>
                    <td class="px-6 py-4">${statusBadge}</td>
                    <td class="px-6 py-4 text-sm text-slate-600">${(t.total_requests || 0).toLocaleString()}</td>
                    <td class="px-6 py-4 text-sm text-slate-600">${lastUsed}</td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="viewTokenDetail(${t.id})" class="p-1.5 text-slate-500 hover:text-blue-600 hover:bg-blue-50 rounded" title="View Details"><i data-lucide="info" class="w-4 h-4"></i></button>
                            ${t.is_active
                                ? `<button onclick="toggleToken(${t.id}, false)" class="p-1.5 text-slate-500 hover:text-orange-600 hover:bg-orange-50 rounded" title="Disable"><i data-lucide="pause-circle" class="w-4 h-4"></i></button>`
                                : `<button onclick="toggleToken(${t.id}, true)" class="p-1.5 text-slate-500 hover:text-green-600 hover:bg-green-50 rounded" title="Enable"><i data-lucide="play-circle" class="w-4 h-4"></i></button>`
                            }
                            <button onclick="deleteToken(${t.id}, '${t.name}')" class="p-1.5 text-slate-500 hover:text-red-600 hover:bg-red-50 rounded" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('') || '<tr><td colspan="7" class="px-6 py-8 text-center text-slate-500">No tokens found. Create one to get started.</td></tr>';

            lucide.createIcons();
        }

        function showCreateTokenModal() {
            document.getElementById('createTokenForm').reset();
            document.getElementById('createTokenModal').showModal();
        }

        async function handleCreateToken(e) {
            e.preventDefault();
            const form = new FormData(e.target);
            const body = {
                name: form.get('name'),
                description: form.get('description'),
                environment: form.get('environment'),
                scopes: form.get('scopes') ? form.get('scopes').split(',').map(s => s.trim()).filter(Boolean) : [],
                ip_whitelist: form.get('ip_whitelist') ? form.get('ip_whitelist').split(',').map(s => s.trim()).filter(Boolean) : [],
                rate_limit_per_minute: parseInt(form.get('rate_limit_per_minute')) || 100,
                rate_limit_per_hour: parseInt(form.get('rate_limit_per_hour')) || 5000,
                rate_limit_per_day: 100000
            };
            if (form.get('expires_at')) body.expires_at = new Date(form.get('expires_at')).toISOString();

            const data = await apiFetch(`${API_BASE}/tokens`, { method: 'POST', body: JSON.stringify(body) });
            if (!data) return;
            document.getElementById('createTokenModal').close();

            if (data.success) {
                document.getElementById('newTokenValue').value = data.data.token;
                document.getElementById('tokenCreatedModal').showModal();
            } else {
                alert(data.message || 'Failed to create token');
            }
        }

        function copyToken() {
            const input = document.getElementById('newTokenValue');
            input.select();
            navigator.clipboard.writeText(input.value);
            // Visual feedback could go here
        }

        async function toggleToken(id, enable) {
            await apiFetch(`${API_BASE}/tokens/${id}/${enable ? 'enable' : 'disable'}`, { method: 'PATCH' });
            loadTokens();
        }

        async function deleteToken(id, name) {
            if (!confirm(`Are you sure you want to delete "${name}"? This cannot be undone.`)) return;
            await apiFetch(`${API_BASE}/tokens/${id}`, { method: 'DELETE' });
            loadTokens();
        }

        async function viewTokenDetail(id) {
            const tokenData = await apiFetch(`${API_BASE}/tokens/${id}`);
            const analyticsData = await apiFetch(`${API_BASE}/analytics/tokens/${id}?days=30`);
            const logsData = await apiFetch(`${API_BASE}/tokens/${id}/logs?limit=10`);

            if (!tokenData || !tokenData.success) return;
            const t = tokenData.data;
            const a = analyticsData?.success ? analyticsData.data : {};
            const logs = logsData?.success ? logsData.data : [];

            document.getElementById('tokenDetailTitle').textContent = t.name;
            document.getElementById('tokenDetailContent').innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-center">
                        <div class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1">Requests</div>
                        <div class="text-xl font-bold text-slate-900">${(a.total_requests || 0).toLocaleString()}</div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-center">
                        <div class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1">Success</div>
                        <div class="text-xl font-bold text-green-600">${(a.successful_requests || 0).toLocaleString()}</div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-center">
                        <div class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1">Failed</div>
                        <div class="text-xl font-bold text-red-600">${(a.failed_requests || 0).toLocaleString()}</div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-center">
                        <div class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1">Avg Latency</div>
                        <div class="text-xl font-bold text-slate-900">${(a.avg_response_time_ms || 0).toFixed(0)}ms</div>
                    </div>
                </div>

                <div class="space-y-3 text-sm border-t border-slate-100 pt-4">
                    <div class="flex justify-between"><span class="text-slate-500">Environment:</span> <span class="font-medium">${t.environment}</span></div>
                    <div class="flex justify-between"><span class="text-slate-500">Created:</span> <span class="font-medium">${new Date(t.created_at).toLocaleString()}</span></div>
                    <div class="flex justify-between"><span class="text-slate-500">Rate Limit:</span> <span class="font-medium">${t.rate_limit_per_minute}/min</span></div>
                </div>

                <div class="pt-4">
                    <h4 class="font-semibold text-sm mb-3">Recent Activity</h4>
                    <div class="overflow-hidden rounded-lg border border-slate-200">
                        <table class="w-full text-xs">
                            <thead class="bg-slate-50 text-slate-500">
                                <tr><th class="px-3 py-2 text-left">Time</th><th class="px-3 py-2 text-left">Method</th><th class="px-3 py-2 text-left">Status</th></tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 bg-white">
                                ${logs.map(l => `<tr>
                                    <td class="px-3 py-2 text-slate-600">${new Date(l.created_at).toLocaleTimeString()}</td>
                                    <td class="px-3 py-2 font-mono">${l.method} ${l.endpoint}</td>
                                    <td class="px-3 py-2"><span class="badge ${l.status_code < 300 ? 'badge-success' : 'badge-error'}">${l.status_code}</span></td>
                                </tr>`).join('') || '<tr><td colspan="3" class="p-3 text-center text-slate-400">No logs</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            document.getElementById('tokenDetailModal').showModal();
        }

        // Analytics
        async function loadAnalytics() {
            const daily = await apiFetch(`${API_BASE}/analytics/daily?days=30`);
            if (daily && daily.success && daily.data.length > 0) {
                const labels = [...new Set(daily.data.map(d => d.date))].sort();
                const success = labels.map(l => daily.data.filter(d => d.date === l).reduce((a, b) => a + b.successful_requests, 0));
                const failed = labels.map(l => daily.data.filter(d => d.date === l).reduce((a, b) => a + b.failed_requests, 0));

                if (analyticsChartInstance) analyticsChartInstance.destroy();
                const ctx = document.getElementById('analyticsChart').getContext('2d');
                analyticsChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: 'Success',
                                data: success,
                                borderColor: '#16A34A',
                                backgroundColor: 'rgba(22, 163, 74, 0.1)',
                                fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 4
                            },
                            {
                                label: 'Failed',
                                data: failed,
                                borderColor: '#DC2626',
                                backgroundColor: 'rgba(220, 38, 38, 0.1)',
                                fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: { y: { beginAtZero: true, border: { display: false } }, x: { grid: { display: false } } },
                        plugins: { legend: { position: 'top', align: 'end', labels: { usePointStyle: true, boxWidth: 6 } } }
                    }
                });
            }

            const endpoints = await apiFetch(`${API_BASE}/analytics/endpoints?days=30&limit=20`);
            if (endpoints && endpoints.success) {
                const tbody = document.querySelector('#analyticsEndpointsTable tbody');
                tbody.innerHTML = endpoints.data.map(e => `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-6 py-4 font-mono text-xs truncate max-w-[200px] text-slate-600">${e.endpoint}</td>
                        <td class="px-6 py-4"><span class="px-2 py-0.5 rounded bg-slate-100 text-slate-600 font-bold text-xs">${e.method}</span></td>
                        <td class="px-6 py-4 font-medium">${e.request_count.toLocaleString()}</td>
                        <td class="px-6 py-4 text-green-600 font-medium">${e.successful_requests}</td>
                        <td class="px-6 py-4 text-red-600 font-medium">${e.failed_requests}</td>
                        <td class="px-6 py-4 text-slate-500">${(e.avg_response_time_ms || 0).toFixed(0)}ms</td>
                    </tr>
                `).join('') || '<tr><td colspan="6" class="px-6 py-8 text-center text-slate-500">No data available</td></tr>';
            }
        }

        // Audit Logs
        async function loadAuditLogs() {
            const data = await apiFetch(`${API_BASE}/audit-logs?limit=100`);
            if (!data || !data.success) return;
            const tbody = document.getElementById('auditBody');
            tbody.innerHTML = data.data.map(l => {
                const badgeClass = {
                    create_token: 'badge-success', delete_token: 'badge-error', disable_token: 'badge-warning',
                    enable_token: 'badge-success', update_token: 'badge-neutral'
                }[l.action] || 'badge-neutral';

                return `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4 text-slate-500 whitespace-nowrap">${new Date(l.created_at).toLocaleString()}</td>
                    <td class="px-6 py-4"><span class="badge ${badgeClass}">${l.action}</span></td>
                    <td class="px-6 py-4 font-mono text-xs text-slate-600">${l.resource_type} #${l.resource_id || '?'}</td>
                    <td class="px-6 py-4 text-slate-600">${l.description || '-'}</td>
                    <td class="px-6 py-4 text-slate-500 text-xs font-mono">${l.ip_address || '-'}</td>
                </tr>`;
            }).join('') || '<tr><td colspan="5" class="px-6 py-8 text-center text-slate-500">No logs found</td></tr>';
        }

        // Initialize
        loadDashboard();
    </script>
</body>
</html>
